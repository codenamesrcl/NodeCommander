(function () {
    'use strict';

    /**
     *
     * @ngdoc module
     * @module  manager
     * @name  manager
     * 
     * 
     * @description
     * A generic angular module
     */
    var app = angular.module('manager', [
        // Angular modules 
        'ngAnimate',
        //'ngRoute'
        //'ngSanitize',
        // Custom modules 
        "gen",       
        "nodetools", 
        "appConfig",
        'ui.bootstrap'
        // 3rd Party Modules
    ]);

    app.constant('appContext', {
        
    });

    app.run(onRun);

    //onRun.$inject = [];

    function onRun() {

    }

})();


(function(){
	'use strict'

	angular
		.module('manager')
		.controller('shell', Shell);

	Shell.$inject = [];

	function Shell(){
		var vm = this;
			
		

	}

}());

(function(){
	'use strict'

	angular
		.module('manager')
		.directive('childProcess', directive);

	directive.$inject = ['lodash'];

	function directive(_){
		var directive = {
	        restrict: 'EA',
	        templateUrl: '/app/manager/components/childProcess/childProcess.html',
	        scope: {
	        	directivename: '@',
	        	parentdirective: '@',
	        	processname: "@",
	        	outputlimit: '@',
	        	command: "@",
	        	commandConfig: "@"
	        },
	        link: link,
	        controller: Controller,
	        controllerAs: 'vm',
	        bindToController: true
	    };

	    return directive;

	    function link(scope, el, attr) {
	    	//console.log(scope.vm.commandConfig);
	    }

	}

	Controller.$inject = ['lodash', 'execFactory', '$scope']

	function Controller(_, execFactory, $scope) {
	    var vm = this;
	    vm.stdout = [];

	   	vm.started = false;
	    vm.visible = false;

	    /**
	     * vm.outputlimit
	     * vm.command
	     */
	    var eventHandler = function(eventtype, data){
	    	switch(eventtype){
	    		case "stdout.data":
	    			_appendStdOut(data);
	    			break;
	    		case "close":
	    			vm.status = "idle";	
	    			_execRunner.kill();
	    			vm.started = false;
	    			_appendStdOut("process closed with code " + data);
	    			break;
	    		case 'exit':
	    			vm.status = "idle";	
	    			_execRunner.kill();
	    			vm.started = false;
	    			_appendStdOut("process exited with code " + data);
	    			break;
	    	}
	    	$scope.$digest();
	    }
	    function _appendStdOut(data){
	    	data = _.filter(data.split('\n'), function(item, index){
	    		if(item.trim().length > 0){
	    			return item;
	    		}
	    	});
	    	_.forEach(data, function(item, index){
	    		vm.stdout.push({
					id: -1,
					data: item
				});	
	    	});
	    	
			vm.stdout = _.map(_.takeRight(vm.stdout, vm.outputlimit), function(item, index){
				item.id = index;
				return item;
			})
	    }

	    var _execRunner = execFactory.newRunner(vm.command, JSON.parse(vm.commandConfig), eventHandler);


	    vm.toggleVisiblity = function(){
	    	vm.visible = !vm.visible;
	    }

	    vm.toggleStart = function(){
	    	if(vm.started){	
	    		_execRunner.kill();
	    	}
	    	else{
	    		_execRunner.run();
	    	}
	    	vm.started = !vm.started;
	    }
	    vm.btnStartText = function(){
	    	return vm.started ? 'Stop' : 'Start';
	    }
	    vm.txtStatus = function(){
	    	return vm.started ? 'Running' : 'Idle';
	    }



	    init();
	    function init(){
	    	vm.processname = vm.processname || "Process";
	    	vm.outputlimit = _.parseInt(vm.outputlimit || '100');
	    	_execRunner.setCommand(vm.command, false);
	    }

	}

}());


(function(){
	'use strict'

	angular
		.module('manager')
		.controller('angularTab', controller);

	controller.$inject = ['lodash', 'appConfig.serverConfig'];

	function controller(_, serverConfig){
		var vm = this;
		
		vm.childProcessList = [];

		function ChildProcessDef(config){
			if(!config.path){
				throw 'path required';
			}
			if(!config.mainTarget){
				throw 'main target required';
			}

			this.name = config.name || '';
			this.path = config.path || '';
			this.mainTarget = config.mainTarget || '';
			this.expectedPort = config.expectedPort || '';
			this.commandConfig = config.commandConfig || {};
			
			this.explicitCommand = config.explicitCommand || null;

			this.displayName = this.name;
			if(config.expectedPort){
				this.displayName += ': ' + config.expectedPort;
			}
		}
		ChildProcessDef.prototype.makeFunc = function(){
			//construct the function to run based on the instance values
			console.log(this.explicitCommand);
			if(!this.explicitCommand){
				var command = "node " + this.mainTarget;

				return command;
			}

			return this.explicitCommand;
		};

		function init(){
			var configkeys = _.keys(serverConfig.config);

			//based on the keys, generate the list of elements
			vm.childProcessList = _.map(configkeys, function(key){
				var setconfig = serverConfig.config[key];

				//ChildProcessDef({config})
				var item = new ChildProcessDef({
					name: key,
					path: setconfig.path,
					mainTarget: setconfig.main,
					expectedPort: setconfig.port,
					explicitCommand: setconfig.explicitCommand,
					commandConfig: {
						cwd: setconfig.path
					}
				});

				return item;
			});
			

			console.log(vm.childProcessList);
		}
		init();

	}

}());

//# sourceMappingURL=manager.min.js.map